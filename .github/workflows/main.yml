name: CI/CD for CVProject1

on:
  push:
    branches: [ main ]

jobs:
  # üèóÔ∏è BUILD BLOCK
  build:
    name: Build Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Build Image using docker-compose.yml
        run: |
          docker compose up build
          echo "‚úÖ Build finished successfully."

      - name: Save Built Image Artifact
        run: |
          docker save cvproject1:latest -o cvproject1.tar

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cvproject1-image
          path: cvproject1.tar

  # üöÄ DEPLOY BLOCK
  deploy:
    name: Deploy and Test
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: cvproject1-image

      - name: Load Image
        run: docker load -i cvproject1.tar

      - name: Deploy using Docker Compose
        run: |
          docker compose up -d deploy
          sleep 5
          docker ps

      - name: Test Application Response
        run: |
          echo "üß™ Testing container..."
          curl -f http://localhost:3003 || (echo "‚ùå App failed to start!" && exit 1)
          echo "‚úÖ Application is running successfully!"

      - name: Clean Up
        run: |
          docker compose down
          docker system prune -f
